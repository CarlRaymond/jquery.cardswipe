/*! jQuery.CardSwipe Magnetic Stripe Card Reader - v2.0.1 - 2015-08-25
* https://github.com/CarlRaymond/jquery.cardswipe
* Copyright (c) 2015 Carl J. Raymond; Licensed GPLv2 */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){var b=function(a){if(w[a])return w[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"!=typeof a&&a)throw"Method "+a+" does not exist on jQuery.cardswipe";return w.init.apply(this,arguments)};a.cardswipe=b;var c,d,e={generic:function(a){var b=new RegExp("^(%[^%;\\?]+\\?)?(;[0-9\\:<>\\=]+\\?)?([+;][0-9\\:<>\\=]+\\?)?"),c=b.exec(a);if(!c)return null;var d={type:"generic",line1:c[1]?c[1].substr(1,c[1].length-2):"",line2:c[2]?c[2].substr(1,c[2].length-2):"",line3:c[3]?c[3].substr(1,c[3].length-2):""};return d},visa:function(a){var b=new RegExp("^%B(4[0-9]{12,18})\\^([A-Z ]+)/([A-Z ]+)\\^([0-9]{2})([0-9]{2})"),c=b.exec(a);if(!c)return null;var d=c[1];if(!v(d))return null;var e={type:"visa",account:d,lastName:c[2].trim(),firstName:c[3].trim(),expYear:c[4],expMonth:c[5]};return e},mastercard:function(a){var b=new RegExp("^%B(5[1-5][0-9]{14})\\^([A-Z ]+)/([A-Z ]+)\\^([0-9]{2})([0-9]{2})"),c=b.exec(a);if(!c)return null;var d=c[1];if(!v(d))return null;var e={type:"mastercard",account:d,lastName:c[2],firstName:c[3],expYear:c[4],expMonth:c[5]};return e},amex:function(a){var b=new RegExp("^%B(3[4|7][0-9]{13})\\^([A-Z ]+)/([A-Z ]+)\\^([0-9]{2})([0-9]{2})"),c=b.exec(a);if(!c)return null;var d=c[1];if(!v(d))return null;var e={type:"amex",account:d,lastName:c[2],firstName:c[3],expYear:c[4],expMonth:c[5]};return e}},f={IDLE:0,PENDING:1,READING:2,DISCARD:3,PREFIX:4},g={0:"IDLE",1:"PENDING",2:"READING",3:"DISCARD",4:"PREFIX"},h=f.IDLE,i=function(){if(0===arguments.length)return h;var b=arguments[0];b!=i&&(d.debug&&console.log("%s -> %s",g[h],g[b]),b==f.READING&&a(document).trigger("scanstart.cardswipe"),h==f.READING&&a(document).trigger("scanend.cardswipe"),h=b)},j=0,k=function(b){switch(d.debug&&console.log(b.which+": "+String.fromCharCode(b.which)),i()){case f.IDLE:37==b.which&&(i(f.PENDING),c=[],l(b.which),b.preventDefault(),b.stopPropagation(),m()),d.prefixCode&&d.prefixCode==b.which&&(i(f.PREFIX),b.preventDefault(),b.stopPropagation(),m());break;case f.PENDING:b.which>=65&&b.which<=90||b.which>=97&&b.which<=122?(i(f.READING),a("input").blur(),l(b.which),b.preventDefault(),b.stopPropagation(),m()):(n(),c=null,i(f.IDLE));break;case f.READING:l(b.which),m(),b.preventDefault(),b.stopPropagation(),13==b.which&&(n(),i(f.IDLE),p()),d.firstLineOnly&&63==b.which&&(i(f.DISCARD),p());break;case f.DISCARD:if(b.preventDefault(),b.stopPropagation(),13==b.which)return n(),void i(f.IDLE);m();break;case f.PREFIX:if(b.which==d.prefixCode)return void i(f.IDLE);b.preventDefault(),b.stopPropagation(),37==b.which&&(i(f.PENDING),c=[],l(b.which)),m()}},l=function(a){c.push(String.fromCharCode(a))},m=function(){clearTimeout(j),j=setTimeout(o,d.interdigitTimeout)},n=function(){clearTimeout(j),j=0},o=function(){d.debug&&console.log("Timeout!"),i()==f.READING&&p(),c=null,i(f.IDLE)},p=function(){d.debug&&console.log(c);var b=c.join("");d.rawDataCallback&&d.rawDataCallback.call(this,b);var e=q(b);e?(d.complete&&d.complete.call(this,e),a(document).trigger("success.cardswipe",e)):(d.error&&d.error.call(this,b),a(document).trigger("failure.cardswipe"))},q=function(b){for(var c=0;c<d.parsers.length;c++){var f,g=d.parsers[c];if(a.isFunction(g)?f=g:"string"==typeof g&&(f=e[g]),null!=f){var h=f.call(this,b);if(null==h)continue;return h}}return null},r=function(){a(document).on("keypress.cardswipe",k)},s=function(){a(document).off(".cardswipe",k)},t=function(a){var b=["Line 1: ",a.line1,"\nLine 2: ",a.line2,"\nLine 3: ",a.line3].join("");alert(b)},u={enabled:!0,interdigitTimeout:250,complete:t,error:null,parsers:["generic"],firstLineOnly:!1,prefixCharacter:null,debug:!1},v=function(a){for(var b=[0,2,4,6,8,1,3,5,7,9],c=0,d=a.length,e=!0;d--;){var f=parseInt(a.charAt(d),10);c+=e?f:b[f],e=!e}return c%10===0&&c>0},w={init:function(b){if(d=a.extend({},u,b),d.prefixCharacter){if(1!=d.prefixCharacter.length)throw"prefixCharacter must be a single character";d.prefixCode=d.prefixCharacter.charCodeAt(0)}n(),i(f.IDLE),c=null,s(),d.enabled&&w.enable()},disable:function(){s()},enable:function(){r()},_parseData:function(a){return q(a)},_getState:function(){return h},_getStates:function(){return f},_getSettings:function(){return d},_builtinParsers:function(){return e}}});