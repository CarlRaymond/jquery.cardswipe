/*! jQuery.CardSwipe Magnetic Stripe Card Reader - v1.0.1 - 2015-11-04
* https://github.com/CarlRaymond/jquery.cardswipe
* Copyright (c) 2015 Carl J. Raymond; Licensed MIT */
!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){var n,r,t,i=function(e){if(C[e])return C[e].apply(this,Array.prototype.slice.call(arguments,1));if("object"!=typeof e&&e)throw"Method "+e+" does not exist on jQuery.cardswipe";return C.init.apply(this,arguments)},a={generic:function(e){var n=new RegExp("^(%[^%;\\?]+\\?)?(;[0-9\\:<>\\=]+\\?)?([+;][0-9\\:<>\\=]+\\?)?"),r=n.exec(e);if(!r)return null;var t={type:"generic",line1:r[1]?r[1].slice(1,-1):"",line2:r[2]?r[2].slice(1,-1):"",line3:r[3]?r[3].slice(1,-1):""};return t},visa:function(e){var n=new RegExp("^%B(4[0-9]{12,18})\\^([A-Z ./]+)\\^([0-9]{2})([0-9]{2})"),r=n.exec(e);if(!r)return null;var t=r[1];if(!x(t))return null;var i={type:"visa",account:t,name:r[2].trim(),expYear:r[3],expMonth:r[4]};return i},mastercard:function(e){var n=new RegExp("^%B(5[1-5][0-9]{14})\\^([A-Z ./]+)\\^([0-9]{2})([0-9]{2})"),r=n.exec(e);if(!r)return null;var t=r[1];if(!x(t))return null;var i={type:"mastercard",account:t,name:r[2],expYear:r[3],expMonth:r[4]};return i},amex:function(e){var n=new RegExp("^%B(3[4|7][0-9]{13})\\^([A-Z ./]+)\\^([0-9]{2})([0-9]{2})"),r=n.exec(e);if(!r)return null;var t=r[1];if(!x(t))return null;var i={type:"amex",account:t,name:r[2],expYear:r[3],expMonth:r[4]};return i}},c={IDLE:0,PENDING:1,READING:2,DISCARD:3,PREFIX:4},u={0:"IDLE",1:"PENDING",2:"READING",3:"DISCARD",4:"PREFIX"},o=c.IDLE,l=function(){if(0===arguments.length)return o;var e=arguments[0];e!=l&&(r.debug&&console.log("%s -> %s",u[o],u[e]),e==c.READING&&t.trigger("scanstart.cardswipe"),o==c.READING&&t.trigger("scanend.cardswipe"),o=e)},s=0,f=function(t){switch(r.debug&&console.log(t.which+": "+String.fromCharCode(t.which)),l()){case c.IDLE:37==t.which&&(l(c.PENDING),n=[],p(t.which),t.preventDefault(),t.stopPropagation(),h()),r.prefixCode&&r.prefixCode==t.which&&(l(c.PREFIX),t.preventDefault(),t.stopPropagation(),h());break;case c.PENDING:t.which>=65&&t.which<=90||t.which>=97&&t.which<=122?(l(c.READING),e("input").blur(),p(t.which),t.preventDefault(),t.stopPropagation(),h()):(g(),n=null,l(c.IDLE));break;case c.READING:p(t.which),h(),t.preventDefault(),t.stopPropagation(),13==t.which&&(g(),l(c.IDLE),D()),r.firstLineOnly&&63==t.which&&(l(c.DISCARD),D());break;case c.DISCARD:if(t.preventDefault(),t.stopPropagation(),13==t.which)return g(),void l(c.IDLE);h();break;case c.PREFIX:if(t.which==r.prefixCode)return void l(c.IDLE);t.preventDefault(),t.stopPropagation(),37==t.which&&(l(c.PENDING),n=[],p(t.which)),h()}},p=function(e){n.push(String.fromCharCode(e))},h=function(){clearTimeout(s),s=setTimeout(d,r.interdigitTimeout)},g=function(){clearTimeout(s),s=0},d=function(){r.debug&&console.log("Timeout!"),l()==c.READING&&D(),n=null,l(c.IDLE)},D=function(){r.debug&&console.log(n);var t=n.join("");r.rawDataCallback&&r.rawDataCallback.call(this,t);var i=w(t);i?(r.success&&r.success.call(this,i),e(document).trigger("success.cardswipe",i)):(r.failure&&r.failure.call(this,t),e(document).trigger("failure.cardswipe"))},w=function(n){for(var t=0;t<r.parsers.length;t++){var i,c=r.parsers[t];if(e.isFunction(c)?i=c:"string"==typeof c&&(i=a[c]),null!=i){var u=i.call(this,n);if(null==u)continue;return u}}return null},v=function(){e(document).on("keypress.cardswipe-listener",f)},I=function(){e(document).off(".cardswipe-listener",f)},E=function(e){var n=["Line 1: ",e.line1,"\nLine 2: ",e.line2,"\nLine 3: ",e.line3].join("");alert(n)},m={enabled:!0,interdigitTimeout:250,success:E,failure:null,parsers:["generic"],firstLineOnly:!1,prefixCharacter:null,eventSource:document,debug:!1},x=function(e){for(var n=[0,2,4,6,8,1,3,5,7,9],r=0,t=e.length,i=!0;t--;){var a=parseInt(e.charAt(t),10);r+=i?a:n[a],i=!i}return r%10===0&&r>0},C={init:function(i){if(r=e.extend({},m,i),r.prefixCharacter){if(1!=r.prefixCharacter.length)throw"prefixCharacter must be a single character";r.prefixCode=r.prefixCharacter.charCodeAt(0)}t=e(r.eventSource),g(),l(c.IDLE),n=null,I(),r.enabled&&C.enable()},disable:function(){I()},enable:function(){v()}};i.luhnChecksum=x,i._states=function(){return c},i._stateNames=function(){return u},i._state=function(){return l()},i._settings=function(){return r},i._parseData=function(e){return w(e)},i._builtinParsers=function(){return a},e.cardswipe=i});